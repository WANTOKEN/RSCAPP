<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="">

		<link rel="shortcut icon" href="img/favicon_1.ico">

		<title>邮差中心</title>

		<!-- Bootstrap core CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/bootstrap-reset.css" rel="stylesheet">

		<!--Animation css-->
		<link href="css/animate.css" rel="stylesheet">

		<!--Icon-fonts css-->
		<link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
		<link href="assets/ionicon/css/ionicons.min.css" rel="stylesheet" />

		<!-- DataTables -->
		<link href="assets/datatables/jquery.dataTables.min.css" rel="stylesheet" type="text/css" />
		<link href="assets/sweet-alert/sweet-alert.min.css" rel="stylesheet">
		<!--Morris Chart CSS -->
		<link rel="stylesheet" href="assets/morris/morris.css">
		<!-- Custom styles for this template -->
		<link href="css/style.css" rel="stylesheet">
		<link href="css/helper.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet" />

	</head>

	<body>

		<!-- Aside Start-->
		<aside class="left-panel">

			<!-- brand -->
			<div class="logo">
				<a href="index.html" class="logo-expanded">
					<img src="img/single-logo.png" alt="logo">
					<span class="nav-label">RSC系统</span>
				</a>
			</div>
			<!-- / brand -->

			<!-- Navbar Start -->
			<nav class="navigation">
				<ul class="list-unstyled">
					<li class="has-submenu">
						<a href="orders.html"><i class="ion-home"></i>
							<span class="nav-label">数据中心</a></span>
						</a>
					</li>
					<li class="has-submenu active">
						<a href="pman.html"><i class="ion-android-social-user"></i>
							<span class="nav-label">邮差中心</span></a>
					</li>
			</nav>

		</aside>
		<!-- Aside Ends-->

		<!--Main Content Start -->
		<section class="content">

			<!-- Header -->
			<header class="top-head container-fluid">
				<button type="button" class="navbar-toggle pull-left">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

				<!-- Search -->
				<form role="search" class="navbar-left app-search pull-left hidden-xs">
					<input type="text" placeholder="搜索..." class="form-control">
				</form>

				<!-- Left navbar -->
				<nav class=" navbar-default hidden-xs" role="navigation">
					<ul class="nav navbar-nav">
						<li class="dropdown">
							<a data-toggle="dropdown" class="dropdown-toggle" href="index.html#">Language<span class="caret"></span></a>
							<ul role="menu" class="dropdown-menu">
								<li>
									<a href="index.html#">中文简体</a>
								</li>
								<li>
									<a href="index.html#">English</a>
								</li>
							</ul>
						</li>
					</ul>
				</nav>

			</header>
			<!-- Header Ends -->
			<!-- Page Content Start -->
			<!-- ================== -->
			<div class="wraper container-fluid">
				<div class="page-title">
					<h3 class="title">邮差中心</h3>
				</div>
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-default">
							<div class="panel-heading">
								<h3 class="panel-title">邮差数据</h3>
							</div>
							<div class="panel-body">
								<div class="row">
									<div class="col-md-12 col-sm-12 col-xs-12">
										<table id="datatable" class="table table-striped table-bordered">
											<thead>
												<tr>
													<th style="text-align: center;">邮差账号</th>
													<th style="text-align: center;">邮差姓名</th>
													<th style="text-align: center;">等级</th>
													<th style="text-align: center;">收益</th>
													<th style="text-align: center;">注册时间</th>
													<th style="text-align: center;">工作区域</th>
													<th style="text-align: center;">工作地址</th>
													<th style="text-align: center;">状态</th>
													<th style="text-align: center;">操作</th>
												</tr>
											</thead>
											<tbody id="data-row" style="text-align: center;">
											</tbody>
										</table>

									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
				<!-- End Row -->

				<div id="balancedetail-model" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
					<div class="modal-dialog modal-lg" id="balancedetail">
						<div class="modal-content p-0 b-0">
							<div class="panel panel-color panel-primary">
								<div class="panel-heading">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
									<h3 class="panel-title"><span class="balance_username"></span></h3>
								</div>
								<div class="panel-body">
									<ol class="list-inline">
									</ol>
									<hr>
									<div class="col-md-12 col-sm-12 col-xs-12">
										<table class="table table-striped table-bordered smalltable">
											<thead>
												<tr>
													<th>日期</th>
													<th>收件数量</th>
													<th>派件数量</th>
												</tr>
											</thead>
										</table>
									</div>
								</div>
							</div>
						</div>
						<!-- /.modal-content -->

					</div>
					<!-- /.modal-dialog -->

				</div>
				<div class="row">
					<div class="col-md-12 col-sm-12 col-xs-12">
						<div class="portlet">
							<!-- /primary heading -->
							<div class="portlet-heading">
								<h3 class="portlet-title text-dark usertitle2">
                                                                        工作情况
                                </h3>
								<div class="portlet-widgets">
									<a href="javascript:;" data-toggle="reload"><i class="ion-refresh"></i></a>
									<span class="divider"></span>
									<a data-toggle="collapse" data-parent="#accordion1" href="chartjs.html#portlet3"><i class="ion-minus-round"></i></a>
									<span class="divider"></span>
									<a href="chartjs.html#" data-toggle="remove"><i class="ion-close-round"></i></a>
								</div>
								<div class="clearfix"></div>
							</div>
							<div id="portlet3" class="panel-collapse collapse in">
								<div class="portlet-body">
									<div class="chart" id="pieChart" style="width: 100%;"></div>

									<div class="row text-center m-t-10">
										<div class="col-sm-9">
											<div class="form-group">
												<div class="col-sm-4">
													<input type="search" class="form-control" autocomplete="on" autofocus="autofocus" id="pid" list="autoType" />
													<datalist id="autoType">
													</datalist>
												</div>
												<div class="col-sm-3">
													<select class="form-control" id="year">
														<option value="2018-">2018</option>
														<option value="2017-">2017</option>
														<option value="2016-">2016</option>

													</select>
												</div>
												<div class="col-sm-3">
													<select class="form-control" id="month">
														<option value="01">1月</option>
														<option value="02">2月</option>
														<option value="03">3月</option>
														<option value="04">4月</option>
														<option value="05">5月</option>
														<option value="06">6月</option>
														<option value="07">7月</option>
														<option value="08">8月</option>
														<option value="09">9月</option>
														<option value="10">10月</option>
														<option value="11">11月</option>
														<option value="12">12月</option>
													</select>
												</div>

											</div>

										</div>
										<div class="col-sm-3">
											<button type="button" class="btn btn-info searchbtn">查询</button>
										</div>

									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-12">
						<div class="portlet">
							<!-- /primary heading -->
							<div class="portlet-heading">
								<h3 class="portlet-title text-dark text-uppercase usertile">
								</h3>
								<div class="portlet-widgets">
									<a href="javascript:;" data-toggle="reload"><i class="ion-refresh"></i></a>
									<span class="divider"></span>
									<a data-toggle="collapse" data-parent="#accordion1" href="index.html#portlet1"><i class="ion-minus-round"></i></a>
									<span class="divider"></span>
									<a href="index.html#" data-toggle="remove"><i class="ion-close-round"></i></a>
								</div>
								<div class="clearfix"></div>
							</div>
							<div id="portlet1" class="panel-collapse collapse in">
								<div class="portlet-body">
									<div id="morris-bar-example" style="height: 320px;"></div>
									<div class="row text-center m-t-30">
										<div class="col-sm-9">
											<div class="form-group">
												<div class="col-sm-5">
													<input type="date" class="form-control" id="formDate" />
												</div>
												<div class="col-sm-1" style="line-height: 30px;">至</div>
												<div class="col-sm-5">
													<input type="date" class="form-control" id="toDate" />
												</div>
											</div>

										</div>
										<div class="col-sm-3">
										</div>
									</div>
									<div class="row text-center m-t-30">
										<div class="col-sm-9">
											<div class="form-group">
												<div class="col-sm-3">
													<select class="form-control" id="province">
														<option value="广东省">广东省</option>
													</select>
												</div>
												<div class="col-sm-3">
													<select class="form-control" id="city">
														<option value="广州市">广州市</option>
													</select>
												</div>
												<div class="col-sm-3">
													<select class="form-control" id="area">
														<option value="从化市">从化市</option>
													</select>
												</div>
												<div class="col-sm-3">
													<select class="form-control" id="town">
														<option value="太平镇">太平镇</option>
														<option value="良口镇">良口镇</option>
													</select>
												</div>
											</div>

										</div>
										<div class="col-sm-3">
											<button type="button" class="btn btn-info searchbtn-bar">查询</button>
										</div>

									</div>
								</div>

							</div>

						</div>
						<!-- /Portlet -->
					</div>
					<!-- end col -->

				</div>
				<!-- End row -->
				<!-- /.modal -->
				<!-- Footer Start -->
				<footer class="footer">
					2018 © ZTKing.
				</footer>
				<!-- Footer Ends -->

		</section>
		<!-- Main Content Ends -->

		<!-- js placed at the end of the document so the pages load faster -->
		<script src="js/jquery.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/pace.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/wow.min.js"></script>
		<script src="js/jquery.nicescroll.js" type="text/javascript"></script>

		<script src="assets/sweet-alert/sweet-alert.min.js"></script>

		<script src="js/jquery.app.js"></script>
		<!--vue.js-->
		<script src="js/vue/vue.min.js"></script>
		<script src="js/vue/vue-resource.min.js"></script>

		<script src="js/config.js"></script>
		<script src="assets/datatables/jquery.dataTables.min.js"></script>
		<script src="assets/datatables/dataTables.bootstrap.js"></script>
		<!--Morris Chart-->
		<script src="assets/morris/morris.min.js"></script>
		<script src="assets/morris/raphael.min.js"></script>
		<script src="js/echarts-all.js"></script>

		<script type="text/javascript">
			function setchart(jsonData) {
				//console.log(jsonData);
				var pieChart = echarts.init(document.getElementById('pieChart'));
				var option = {
					calculable: false,
					series: [{
						name: '工作情况',
						type: 'pie',
						radius: '100%',
						center: ['50%', '50%'],
						data: jsonData
					}]
				};
				pieChart.setOption(option);
			}

			function setBar($element, $data) {
				var datajson1 = [{ "num": 4, "name": "收件最多 \n 2018-11-17", },
					{ "num": 10, "name": "收件最少 \n 2018-11-16", },
					{ "num": 5, "name": "派件最多 \n 2018-11-17", },
					{ "num": 9, "name": "派件最少 \n2018-11-18", }
				];
				var datajson = [{ "num": 4, "name": "邮差1", },
					{ "num": 10, "name": "邮差2", },
					{ "num": 5, "name": "邮差3", },
					{ "num": 9, "name": "邮差4", }
				];
				Morris.Bar({
					element: $element,
					data: $data,
					xkey: 'name',
					ykeys: ['num'],
					labels: ['工作量'],
					barColors: ['#3bc0c3']
				});
			}

			function getDatas() {
				var table;
				table = $('#datatable');
				table.dataTable({
					/*"bProcessing": true,*/
					lengthMenu: [
						[10, 25, 50, -1],
						[10, 25, 50, "全部"]
					],
					searching: true, //是否显示查询
					lengthChange: true, //是否使用下位列表选择分页大小
					//ordering:false,//全部禁止排序
					paginationType: "full_numbers", //分页按钮：有精简和全功能几种选项
					//语言国际化设置，默认是英文的
					language: {
						lengthMenu: "显示 _MENU_ 记录", //[[10, 25, 50, -1], [10, 25, 50, "All"]], //"显示 _MENU_ 记录",
						zeroRecords: "没有找到记录",
						info: "每页显示 10 条 当前显示 _START_ 到 _END_ 条，第 <span style='color:red'>_PAGE_</span> 页 ( 总共 _PAGES_ 页 ) 共 _TOTAL_ 条记录",
						infoEmpty: "没有找到记录",
						infoFiltered: "(从 _MAX_ 条记录过滤)",
						paginate: {
							first: "首页",
							previous: " 上一页",
							next: " 下一页 ",
							last: " 尾页 "
						},
						search: "模糊查询：" //查询按钮显示的文本
					},
					"ajax": {
						"url": SERVER_URL + 'getPmanData',
						dataSrc: function(data) { //获取数据之后处理函数，jason就是返回的数据
							console.log(JSON.stringify(data));
							var dataSet = new Array();
							dataSet = data;
							$.each(data, function(index, item) {
								console.log(item.p_account);
								$('#autoType').append('<option value="' + item.p_account + '">"' + item.p_account + '"</option>');
							});
							//对数据处理过程
							return dataSet; //再将数据返回给datatable控件使用
						}
					},
					/*"sAjaxSource": SERVER_URL + 'GoodsData',*/
					"columns": [
						{ "data": "p_account" },
						{ "data": "p_name" },
						{ "data": "level" },
						{
							"data": null,
							"render": function(data, type, row, meta) {

								var html = '<span class="label label-info" data-toggle="tooltip" data-placement="left" title="' + row.sale_total + '">' + row.sale_total + '</span>';
								return html;
							}
						},
						{ "data": "reg_time" },
						{ "data": "workarea" },
						{ "data": "workaddress" },
						{
							"data":  null,
							"render": function(data, type, row, meta) {
								var html ='<select class="form-control" id="pmanstatus">';
									html +='<option value="' + row.status + '" style="color:#fff;background-color:#337ab7">'+row.status+'</option>';
									html +='<option value="请假">请假</option>';
									html +='<option value="休息">休息</option>';
									html +='<option value="工作">工作</option>';
									html +='</select>';	
									html +='<button type="button" class="btn m-b-4 changestatus-btn btn-success" data-userid="' + row.p_account + '"><i class="fa fa-pencil"></i></button>';
													
								 
								return html;
							}

						},
						{
							"data": null,
							"render": function(data, type, row, meta) {

								var html = '<button type="button" data-toggle="modal" class="btn m-b-5 look btn-purple" data-userid="' + row.p_account + '" data-username="' + row.p_name + '"><i class="fa fa-search"></i></button>';
								return html;
							}
						},
					],
					'aoColumnDefs': [{ //去掉排序
						'bSortable': false,
						'aTargets': [-1] /* 1st one, start by the right */
					}],

				});
			}

			function getsmallTable(userid, username) {
				$('.balance_username').html(username + "的收派件情况");
				$('.smalltable').dataTable().fnDestroy();
				var smalltable;
				smalltable = $('.smalltable');
				smalltable.dataTable({
					/*"bProcessing": true,*/
					lengthMenu: [
						[5, 10, 20, -1],
						[5, 10, 20, "全部"]
					],
					searching: true, //是否显示查询
					lengthChange: true, //是否使用下位列表选择分页大小
					//ordering:false,//全部禁止排序
					paginationType: "full_numbers", //分页按钮：有精简和全功能几种选项
					//语言国际化设置，默认是英文的
					language: {
						lengthMenu: "显示 _MENU_ 记录", //[[10, 25, 50, -1], [10, 25, 50, "All"]], //"显示 _MENU_ 记录",
						zeroRecords: "没有找到记录",
						info: "当前显示 _START_ 到 _END_ 条，<span style='color:red'>_PAGE_</span> /_PAGES_页 共 _TOTAL_ 条记录",
						infoEmpty: "没有找到记录",
						infoFiltered: "(从 _MAX_ 条记录过滤)",
						paginate: {
							first: "首页",
							previous: " 上一页",
							next: " 下一页 ",
							last: " 尾页 "
						},
						search: "模糊查询：" //查询按钮显示的文本
					},
					"ajax": {
						"url": SERVER_URL + 'getPmanDetail',
						"data": { pid: userid },
						"dataSrc": function(data) { //获取数据之后处理函数，jason就是返回的数据
							console.log(JSON.stringify(data));
							var dataSet = new Array();
							if(data[0].code == 200) {
								$('#balancedetail-model').modal('show');
								dataSet = data[0].data;
								$('.list-inline').html(counthtml(data[0].count1, data[0].count2));

							} else {
								dataSet = [];
								swal(data[0].msg);
							}

							console.log(JSON.stringify(dataSet));
							//对数据处理过程
							return dataSet; //再将数据返回给datatable控件使用
						}
					},
					/*"sAjaxSource": SERVER_URL + 'GoodsData',*/
					"columns": [
						{ "data": "time" },
						{ "data": "num1" },
						{ "data": "num2" },
					],

				});
			}

			function counthtml(count1, count2) {
				var htmlInfo = '<li>总收件量：<mark><strong>' + count1 + '</strong></mark></li>';
				htmlInfo += '<li>收件总收益：<mark><strong> 1.00(每件) x ' + count1 + '(收件量) = ' + 1 * count1 + '.00(元)</strong></mark></li>'
				htmlInfo += '<br>';
				htmlInfo += '<li>总派件量：<mark><strong>' + count2 + '</strong></mark></li>';
				htmlInfo += '<li>派件总收益：<mark><strong> 1.00(每件) x ' + count2 + '(派件量) = ' + 1 * count2 + '.00(元)</strong></mark></li>'
				return htmlInfo;
			}
			$(document).ready(function() {
				getDatas();
				console.log("ready");
			});
			//查看详情
			$(document).on("click", ".look", function() {
				var userid = $(this).attr('data-userid').toString();
				var username = $(this).attr('data-username').toString();
				console.log(userid + username);
				getsmallTable(userid, username);

			});
			//改变状态
			$(document).on("click", ".changestatus-btn", function() {
				var userid = $(this).attr('data-userid').toString();
				var status = $(this).parent().find('#pmanstatus').val();
				console.log(userid+status);
				$.ajax({
					type: "post",
					data: {
						account: userid,
						status: status,
					},
					url: SERVER_URL + 'setPmanStatus',
					dataType: "json",
					success: function(data) {
						console.log(JSON.stringify(data));
						if(data[0].code == 200) {
							swal(data[0].msg);

						} else {
							swal(data[0].msg);
						}

					}
				});

			});

			function getBarData($area, $begintime, $endtime) {
				$("#morris-bar-example").html('');
				$.ajax({
					type: "get",
					data: {
						area: $area,
						begintime: $begintime,
						endtime: $endtime
					},
					url: SERVER_URL + 'getPmanBarChart2',
					dataType: "json",
					success: function(data) {
						console.log(JSON.stringify(data));
						if(data[0].code == 200) {
							$('.usertile').html(data[0].msg);
							setBar('morris-bar-example', data[0].data);

						} else {
							swal(data[0].msg);
						}

					}
				});

			}

			function getPieData($userid, $currentMonth) {
				$.ajax({
					type: "get",
					data: {
						pid: $userid,
						currentMonth: $currentMonth
					},
					url: SERVER_URL + 'getPmanPieChart',
					dataType: "json",
					success: function(data) {
						console.log(JSON.stringify(data));
						if(data[0].code == 200) {
							setchart(data[0].data);

						} else {
							swal(data[0].msg);
						}

					}
				});

			}
			var myDate = new Date();
			var currentMonth = myDate.getFullYear() + "-" + (myDate.getMonth() + 1);

			$(document).on("click", ".searchbtn", function() {
				var pid = $('#pid').val();
				/*var selectdate = $('#selectdate').val();
				selectdate = selectdate.substring(0, 7);
				console.log(pid + selectdate);*/
				var selectdate = $('#year').val() + $('#month').val();
				console.log(pid + selectdate);
				getPieData(pid, selectdate);

			});
			
			$(document).on("click", ".searchbtn-bar", function() {

				var begindate = $('#formDate').val();
				var enddate = $('#toDate').val();
				if(begindate == "" || enddate == "") {
					swal("请选择查询日期！");
					return;
				}
				var areaval = $('#area').val();
				var town = $('#town').val();
				var searcharea = areaval + town;
				console.log(begindate + "," + enddate + "," + searcharea);
				getBarData(searcharea, begindate, enddate);

			});
		</script>
	</body>

</html>